var Nav;$(function(){function h(a){var b,c,d,e;for(c=0,b=a.split(""),d=0;d<b.length;d++)e=escape(b[d]),c+=-1==e.indexOf("%u",0)?1:2;return c}function j(a){var b=a.match(i),c=escape(a).match(/%u[0-9a-f]{4}/gi),d=c&&c.length?unescape(c).split(","):null;return{en:b,zh:d}}function k(){h(g)>=2?($(".panel-sel").hide(400),Nav.search("#search_result"),$("#search_result").slideDown(400)):($("#search_result").slideUp(200),$(".panel-sel").show())}function n(){parseInt(window.localStorage.getItem(f))+2592e5<new Date&&Nav.syncDB(),window.setTimeout(n,6048e5)}var a,b,c,d,e,f,g,i,m;$("#version").text(chrome.app.getDetails().version),$("#search_words").mouseover(function(){$(this).focus()}).focus(),a="http://nav.8866.org/",b="favorites",c="visitHistory",d="showRecomand",e="searchMethod",f="lastDbUpdate",g="",i=/[0-9]+|((ch|zh|sh)|[bcdfghjklmnpqrstwxyz'])(v|uo|un|ui|ue|uang|uan|uai|ua|u|ou|ong|o|iu|iong|ing|in|ie|iao|iang|ian|ia|i|eng|en|ei|e|ao|ang|an|ai|a)?/gi,$("#search_words").bind({keydown:function(a){13==a.keyCode&&(h(g)<2?alert("请至少输入两个"):k())},keyup:function(){g=$(this).val(),2==Nav.config.searchMethod?k():h(g)<2&&($("#search_result").slideUp(200),$(".panel-sel").show())},blur:function(){var b=this;setTimeout(function(){$(b).val(""),$("#search_result").slideUp(200),$(".panel-sel").show()},150)},webkitspeechchange:function(){g=$(this).val(),k()}}),m={revert:"invalid",helper:"clone",appendTo:"body",scroll:!1,zIndex:999999999},Nav=Nav||function(){return[]},Nav.config={},Nav.db=window.openDatabase("iStudy","1.0","iStudy网址导航数据库",1048576),Nav.syncDB=function(){var b=a+"plugin/syncDB.php",c="CREATE TABLE IF NOT EXISTS sites(id int NOT NULL PRIMARY KEY,cid int NOT NULL DEFAULT 0,name varchar(255) NOT NULL DEFAULT '',url varchar(255) NOT NULL,desc text,pinyin varchar(255))",d="CREATE TABLE IF NOT EXISTS category(cid int NOT NULL PRIMARY KEY,pid int NOT NULL DEFAULT 0, name varchar(255) NOT NULL DEFAULT '',desc text)";$.ajax({url:b,dataType:"json",type:"GET",data:"action=site",timeout:2e3,async:!1,cache:!1,success:function(a){try{"success"===a.status?($("#syncProg").attr({max:a.count,value:0}).css("display","inline"),$(".error").html("正在更新网址..."),Nav.execute(c,[],function(){var c="REPLACE INTO sites (`id`,`cid`,`name`,`url`,`desc`,`pinyin`) values(?,?,?,?,?,?)";Nav.execute(c,a.data,function(c){if($("#syncProg").attr("value",c),c==a.count){var e=Nav.config.count||a.count;e<a.count?chrome.browserAction.setBadgeText({text:"new"}):chrome.browserAction.setBadgeText({text:""}),Nav.config.count=a.count,$(".error").html("Success!!"),$.ajax({url:b,dataType:"json",type:"GET",data:"action=cate",timeout:2e3,cache:!1,success:function(a){try{"success"===a.status?($("#syncProg").attr({max:a.count,value:0}).css("display","inline"),$(".error").html("正在更新分类..."),Nav.execute(d,[],function(){var b="REPLACE INTO category (`cid`,`pid`,`name`,`desc`) values(?,?,?,?)";Nav.execute(b,a.data,function(b){$("#syncProg").attr("value",b),b==a.count&&(Nav.config.lastDbUpdate=(new Date).getTime(),Nav.saveConfig(),$(".error").html("Success!!"))},function(a){$(".error").html(a)})},function(a){alert("数据库创建失败……"+a)})):$(".error").html(a.status)}catch(e){$(".error").html(e)}},error:function(a,b){$(".error").html(b+"，更新失败...请检查您的网络连接！如果还出现问题，请与<a href='mailto:rickytan@zju.edu.cn'>管理员</a>取得联系。")}})}},function(a){$(".error").html(a)})},function(a){alert("数据库创建失败……"+a)})):$(".error").html(a.status)}catch(g){$(".error").html(g)}},error:function(a,b){$(".error").html(b+"，更新失败...请检查您的网络连接！如果还出现问题，请与<a href='mailto:rickytan@zju.edu.cn'>管理员</a>取得联系。")}})},Nav.search=function(a){var b="SELECT MAX(name) name,url,MAX(desc) desc FROM sites WHERE ",c=j(g);c.en&&(b+='pinyin like "%'+c.en.join("%")+'%"'),c.zh&&(c.en&&(b+=" and "),b+='name like "%'+c.zh.join("%")+'%"'),b+=" GROUP BY url LIMIT 0,45",Nav.query(b,[],function(b){var c,d,e;for($(a).empty(),0==b.rows.length&&$(a).append("<li>无结果，请换个关键词哦...</li>"),c=0;c<b.rows.length;++c)d=b.rows.item(c),e='<a href="'+d.url+'" target="_blank" title="'+d.desc+'">'+d.name+"</a>",$(a).append("<li>"+e+"</li")},function(b){$(a).html("查询错误!error:"+b)})},Nav.getCate=function(a,b){var c="SELECT cid,name FROM category WHERE pid=? LIMIT 0,12";Nav.query(c,[a],function(a){var c,d,e;for($(b).empty(),c=0;c<a.rows.length;++c)d=document.createElement("li"),e=a.rows.item(c),$(d).addClass("l2-list").attr("id",e.cid).text(e.name).appendTo(b).click(function(){$("ul.l2 li").removeClass("l2-list-sel"),$(this).addClass("l2-list-sel");var a=$(this).attr("id");indexhtml=$("#indexhtml").html(),Nav.getSite(a,"#indexhtml")})},function(a){$(b).html("<span style='color:red'>查询失败！error:"+a+"</span>")})},Nav.getSite=function(a,b){var c="SELECT name,url,desc FROM sites WHERE cid=? LIMIT 0,50";Nav.query(c,[a],function(a){var c,d,e;for($(b).empty(),c=0;c<a.rows.length;++c)d=a.rows.item(c),e='<a href="'+d.url+'" target="_blank" title="'+d.desc+'">'+d.name+"</a>",$(b).append("<li>"+e+"</li");$("a").draggable(m)},function(a){$(b).html("<span style='color:red'>查询失败！error:"+a+"</span>")})},Nav.recordHist=function(a){var c,b=window.localStorage.getItem("visitlist");for(b=b?b.split(","):[],c=escape(a.innerHTML)+"+"+a.href;b.length>=parseInt(Nav.config.visitHistory);)b.shift();b.indexOf(c)<0&&b.push(c),window.localStorage.setItem("visitlist",b)},Nav.loadIndexHtml=function(b){var d,c=window.localStorage.getItem("indexhtml");null===c||""===c.trim()||"null"===c.trim()?(d=a,$(b).html("正在加载..."),$.get(d,function(a){var c=$(a).find("#indexhtml ul.htop").html();window.localStorage.setItem("indexhtml",c),$(b).html(c)}).onerror=function(){$(b).html("<span style='color:red'>加载失败!</span>")}):$(b).html(c),$("a").draggable(m)},Nav.loadApps=function(b){var d,c=window.localStorage.getItem("apps");null===c||""===c.trim()||"null"===c.trim()?(d=a,$(b).html("正在加载..."),$.get(d,function(a){var c=$(a).find("#tools ul.con").html();window.localStorage.setItem("apps",c),$(b).html(c)}).onerror=function(){$(b).html("<span style='color:red'>加载失败!</span>")}):$(b).html(c),$("a").draggable(m)},Nav.loadRecent=function(a){var b="SELECT url,MAX(name) name,MAX(desc) desc FROM sites GROUP BY url ORDER BY id DESC LIMIT 0,15";Nav.query(b,[],function(b){var c,d,e;for($(a).empty(),c=0;c<b.rows.length;++c)d=b.rows.item(c),e='<a href="'+d.url+'" target="_blank" title="'+d.desc+'">'+d.name+"</a>",$(a).append("<li>"+e+"</li");$("a").draggable(m)},function(b){$(a).html("<span style='color:red'>查询失败！error:"+b+"</span>")})},Nav.loadRecomand=function(b){var c=a+"plugin/reco.json?id="+Math.floor((new Date).getTime()/6e4);$.getJSON(c,function(a){a=a||[["学习网","http://istudy.zuss.zju.edu.cn/"]],a.forEach(function(a){var d='<a href="'+a[1]+'">'+a[0]+"</a>";$(b).append(d)})})},Nav.loadHistory=function(a){var b=window.localStorage.getItem("visitlist");b=b?b.split(","):[],$(a).empty(),b.forEach(function(b){var d=b.split("+"),e='<a href="'+d[1]+'" target="_blank">'+unescape(d[0])+"</a>";$(a).append("<li>"+e+"</li>")}),$("a").draggable(m)},Nav.clearHistory=function(){window.localStorage.setItem("visitlist","")},Nav.loadConfig=function(){var a=window.localStorage;Nav.config.visitHistory=a.getItem(c)||25,Nav.config.showRecomand=a.getItem(d)||"true",Nav.config.searchMethod=a.getItem(e)||2,Nav.config.lastDbUpdate=a.getItem(f)||0,Nav.config.count=a.getItem("count")||0},Nav.saveConfig=function(a){var d,b=a||Nav.config,c=window.localStorage;for(d in b)b.hasOwnProperty(d)&&c.setItem(d,b[d])},Nav.loadFavorite=function(a){var c=window.localStorage.getItem(b);c=c?c.split(","):[],$(a).empty(),c.forEach(function(b){var d=b.split("+"),e='<a href="'+d[1]+'" class="fav" target="_blank">'+unescape(d[0])+"</a>";$(a).append("<li>"+e+"</li>")})},Nav.clearFavorite=function(){window.localStorage.setItem(b,"")},Nav.removeFavorite=function(a){var d,c=window.localStorage.getItem(b);c=c?c.split(","):[],d=escape(a.innerText)+"+"+a.href,c.splice(c.indexOf(d),1),window.localStorage.setItem(b,c)},Nav.addFavorite=function(a){var d,c=window.localStorage.getItem(b);for(c=c?c.split(","):[],d=escape(a.innerText)+"+"+a.href;c.length>=30;)c.shift();c.indexOf(d)<0&&c.push(d),window.localStorage.setItem(b,c)},Nav.defaultConfig=function(){var a=window.localStorage;a.removeItem(c),a.removeItem(d),a.removeItem(e),Nav.loadConfig()},Nav.query=function(a,b,c,d){Nav.db.readTransaction(function(e){e.executeSql(a,b,function(a,b){c&&c(b)},function(a,b){d&&d(b.message)})})},Nav.execute=function(a,b,c,d){Nav.db.transaction(function(e){var f=0,g=0;do e.executeSql(a,b[f],function(){c&&c(++g)},function(a,b){d&&d(b.message)});while(++f<b.length)})},Nav.loadConfig(),n(),$("#tabNav").find("li").each(function(a,b){$(b).click(function(){switch($("#tabNav li").removeClass("current"),$(this).addClass("current"),$("div.panel").removeClass("panel-sel").hide(),$($("div.panel")[a]).addClass("panel-sel").show(),a){case 0:Nav.loadFavorite("#favorite");break;case 1:Nav.loadIndexHtml("#indexhtml");break;case 2:Nav.loadApps("#apps");break;case 3:Nav.loadHistory("#history");break;case 4:Nav.loadRecent("#recent")}return!1})}),$("ul.l1 li").click(function(){$("ul.l1 li").removeClass("l1-list-sel"),$(this).addClass("l1-list-sel");var a=$(this).attr("id");Nav.getCate(a,$("ul.l2"))}),$("#favorite_tab").droppable({accept:"a",activeClass:"actived",hoverClass:"hover",addClasses:!1,tolerance:"pointer",drop:function(a,b){Nav.addFavorite(b.draggable[0]),Nav.loadFavorite("#favorite"),$(this).fadeOut(1e3/6).fadeIn(1e3/6).fadeOut(1e3/6).fadeIn(1e3/6)}}),$("#favorite").sortable({appendTo:"body",items:"li",placeholder:"placeholder",connectWith:"#trash",cursor:"move",start:function(){$("#trash").slideDown("fast")},stop:function(){Nav.clearFavorite(),$(this).find("li").each(function(a,b){Nav.addFavorite(b.children[0])}),$("#trash").slideUp("slow")}}),$("#trash").droppable({accept:"li",tolerance:"pointer",hoverClass:"hover",drop:function(a,b){var c=b.draggable[0].children[0];b.draggable.remove(),Nav.removeFavorite(c)}}),$("#clsHist").button({icons:{primary:"ui-icon-trash"},label:"清空"}).click(function(){Nav.clearHistory(),$("#history").children("li").hide("slow",function(){$(this).remove()})}),$("#addFav").button({icons:{primary:"ui-icon-plus"},label:"增加"}).click(function(){$("#inputDialog").dialog({modal:!0,resizable:!1,show:"slide",hide:"fade",open:function(){$(this).find("input").css({borderColor:"gray"}).val("").last().val("http://")},buttons:{"确定":function(){var c,a=$(this).find("input[name=title]").val(),b=$(this).find("input[name=link]").val();""!=a.trim()?/[a-zA-z]+:\/\/[^\s]*/.test(b)?(c=document.createElement("a"),c.href=b,c.innerHTML=a,Nav.addFavorite(c),Nav.loadFavorite("#favorite"),$(this).dialog("close")):$(this).find("input[name=link]").css({borderColor:"red"}):$(this).find("input[name=title]").css({borderColor:"red"})}}})}),document.onclick=function(a){return a=a||window.event,a=a.target?a.target:a.srcElement,"A"==a.tagName&&""!=a.href.trim()&&"#"!=a.href.trim()?(Nav.recordHist(a),!0):void 0},setTimeout(function(){Nav.loadIndexHtml("#indexhtml")},400),"true"===Nav.config.showRecomand&&Nav.loadRecomand($("#recomand").show(300))});